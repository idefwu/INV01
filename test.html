<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>庫存管理系統 - 功能測試</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .summary {
            background-color: #e2e3e5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>庫存管理系統 - 功能測試</h1>
    
    <div class="test-container">
        <h2>系統初始化測試</h2>
        <button onclick="testSystemInit()">測試系統初始化</button>
        <div id="init-results"></div>
    </div>
    
    <div class="test-container">
        <h2>商品管理測試</h2>
        <button onclick="testProductManagement()">測試商品管理</button>
        <div id="product-results"></div>
    </div>
    
    <div class="test-container">
        <h2>客戶管理測試</h2>
        <button onclick="testCustomerManagement()">測試客戶管理</button>
        <div id="customer-results"></div>
    </div>
    
    <div class="test-container">
        <h2>供應商管理測試</h2>
        <button onclick="testSupplierManagement()">測試供應商管理</button>
        <div id="supplier-results"></div>
    </div>
    
    <div class="test-container">
        <h2>進貨管理測試</h2>
        <button onclick="testPurchaseManagement()">測試進貨管理</button>
        <div id="purchase-results"></div>
    </div>
    
    <div class="test-container">
        <h2>銷貨管理測試</h2>
        <button onclick="testSalesManagement()">測試銷貨管理</button>
        <div id="sales-results"></div>
    </div>
    
    <div class="test-container">
        <h2>庫存管理測試</h2>
        <button onclick="testInventoryManagement()">測試庫存管理</button>
        <div id="inventory-results"></div>
    </div>
    
    <div class="test-container">
        <h2>工具函數測試</h2>
        <button onclick="testUtilities()">測試工具函數</button>
        <div id="utility-results"></div>
    </div>
    
    <div class="test-container">
        <h2>完整流程測試</h2>
        <button onclick="testCompleteWorkflow()">測試完整流程</button>
        <div id="workflow-results"></div>
    </div>
    
    <div class="test-container">
        <button onclick="runAllTests()">執行所有測試</button>
        <button onclick="clearResults()">清除結果</button>
    </div>
    
    <div class="summary" id="test-summary" style="display: none;">
        <h3>測試摘要</h3>
        <div id="summary-content"></div>
    </div>

    <!-- Scripts -->
    <script src="basic/js/models.js"></script>
    <script src="basic/js/utils.js"></script>
    <script src="basic/js/dashboard.js"></script>
    <script src="basic/js/products.js"></script>
    <script src="basic/js/customers.js"></script>
    <script src="basic/js/suppliers.js"></script>
    <script src="basic/js/purchase.js"></script>
    <script src="basic/js/sales.js"></script>
    <script src="basic/js/inventory.js"></script>
    <script src="basic/js/reports.js"></script>
    
    <script>
        let testResults = [];
        let inventorySystem;
        
        function logResult(test, result, details = '') {
            testResults.push({ test, result, details });
            const className = result ? 'test-pass' : 'test-fail';
            const status = result ? '✓ 通過' : '✗ 失敗';
            return `<div class="test-result ${className}">${test}: ${status}${details ? ' - ' + details : ''}</div>`;
        }
        
        function logInfo(message) {
            return `<div class="test-result test-info">ℹ️ ${message}</div>`;
        }
        
        function testSystemInit() {
            const results = document.getElementById('init-results');
            results.innerHTML = '<h3>執行系統初始化測試...</h3>';
            
            try {
                // 測試系統初始化
                inventorySystem = new InventorySystem();
                results.innerHTML += logResult('系統初始化', !!inventorySystem);
                
                // 測試基本屬性
                results.innerHTML += logResult('產品陣列初始化', Array.isArray(inventorySystem.products));
                results.innerHTML += logResult('客戶陣列初始化', Array.isArray(inventorySystem.customers));
                results.innerHTML += logResult('供應商陣列初始化', Array.isArray(inventorySystem.suppliers));
                results.innerHTML += logResult('進貨單陣列初始化', Array.isArray(inventorySystem.purchaseOrders));
                results.innerHTML += logResult('銷貨單陣列初始化', Array.isArray(inventorySystem.salesOrders));
                
                // 測試ID生成
                const productId = inventorySystem.generateId('product');
                results.innerHTML += logResult('產品ID生成', productId && productId.startsWith('P'));
                
                const customerId = inventorySystem.generateId('customer');
                results.innerHTML += logResult('客戶ID生成', customerId && customerId.startsWith('C'));
                
                results.innerHTML += logInfo(`生成的產品ID: ${productId}, 客戶ID: ${customerId}`);
                
            } catch (error) {
                results.innerHTML += logResult('系統初始化異常', false, error.message);
            }
        }
        
        function testProductManagement() {
            const results = document.getElementById('product-results');
            results.innerHTML = '<h3>執行商品管理測試...</h3>';
            
            try {
                if (!inventorySystem) {
                    inventorySystem = new InventorySystem();
                }
                
                const initialCount = inventorySystem.products.length;
                
                // 測試新增商品
                const product = inventorySystem.addProduct(
                    'TEST001', '測試商品', '測試規格', '個', 100, 150, 10, 50
                );
                
                results.innerHTML += logResult('新增商品', !!product);
                results.innerHTML += logResult('商品數量增加', inventorySystem.products.length === initialCount + 1);
                
                if (product) {
                    results.innerHTML += logResult('商品編號正確', product.code === 'TEST001');
                    results.innerHTML += logResult('商品名稱正確', product.name === '測試商品');
                    results.innerHTML += logResult('庫存價值計算', product.getStockValue() === 5000); // 50 * 100
                    results.innerHTML += logResult('低庫存檢查', product.isLowStock() === false); // 50 > 10
                }
                
                // 測試商品搜尋
                const foundProducts = inventorySystem.searchProducts('測試');
                results.innerHTML += logResult('商品搜尋', foundProducts.length > 0);
                
                // 測試商品更新
                if (product) {
                    product.name = '更新的測試商品';
                    results.innerHTML += logResult('商品更新', product.name === '更新的測試商品');
                }
                
                results.innerHTML += logInfo(`目前商品總數: ${inventorySystem.products.length}`);
                
            } catch (error) {
                results.innerHTML += logResult('商品管理測試異常', false, error.message);
            }
        }
        
        function testCustomerManagement() {
            const results = document.getElementById('customer-results');
            results.innerHTML = '<h3>執行客戶管理測試...</h3>';
            
            try {
                if (!inventorySystem) {
                    inventorySystem = new InventorySystem();
                }
                
                const initialCount = inventorySystem.customers.length;
                
                // 測試新增客戶
                const customer = inventorySystem.addCustomer(
                    '測試客戶', '0912345678', 'test@example.com', '台北市信義區'
                );
                
                results.innerHTML += logResult('新增客戶', !!customer);
                results.innerHTML += logResult('客戶數量增加', inventorySystem.customers.length === initialCount + 1);
                
                if (customer) {
                    results.innerHTML += logResult('客戶姓名正確', customer.name === '測試客戶');
                    results.innerHTML += logResult('客戶電話正確', customer.phone === '0912345678');
                }
                
                results.innerHTML += logInfo(`目前客戶總數: ${inventorySystem.customers.length}`);
                
            } catch (error) {
                results.innerHTML += logResult('客戶管理測試異常', false, error.message);
            }
        }
        
        function testSupplierManagement() {
            const results = document.getElementById('supplier-results');
            results.innerHTML = '<h3>執行供應商管理測試...</h3>';
            
            try {
                if (!inventorySystem) {
                    inventorySystem = new InventorySystem();
                }
                
                const initialCount = inventorySystem.suppliers.length;
                
                // 測試新增供應商
                const supplier = inventorySystem.addSupplier(
                    '測試供應商', '王小明', '02-12345678', 'supplier@example.com', '新北市板橋區', '12345678'
                );
                
                results.innerHTML += logResult('新增供應商', !!supplier);
                results.innerHTML += logResult('供應商數量增加', inventorySystem.suppliers.length === initialCount + 1);
                
                if (supplier) {
                    results.innerHTML += logResult('供應商名稱正確', supplier.name === '測試供應商');
                    results.innerHTML += logResult('聯絡人正確', supplier.contactPerson === '王小明');
                }
                
                results.innerHTML += logInfo(`目前供應商總數: ${inventorySystem.suppliers.length}`);
                
            } catch (error) {
                results.innerHTML += logResult('供應商管理測試異常', false, error.message);
            }
        }
        
        function testPurchaseManagement() {
            const results = document.getElementById('purchase-results');
            results.innerHTML = '<h3>執行進貨管理測試...</h3>';
            
            try {
                if (!inventorySystem) {
                    inventorySystem = new InventorySystem();
                    // 確保有商品和供應商
                    inventorySystem.addProduct('TEST001', '測試商品', '', '個', 100, 150, 10, 0);
                    inventorySystem.addSupplier('測試供應商', '王小明', '02-12345678', '', '', '');
                }
                
                const supplier = inventorySystem.suppliers[0];
                const product = inventorySystem.products[0];
                
                if (!supplier || !product) {
                    results.innerHTML += logResult('進貨測試準備', false, '缺少必要的供應商或商品資料');
                    return;
                }
                
                const initialOrderCount = inventorySystem.purchaseOrders.length;
                const initialStock = product.currentStock;
                
                // 測試建立進貨單
                const purchaseOrder = inventorySystem.createPurchaseOrder(
                    supplier.id,
                    new Date().toISOString().split('T')[0],
                    [{ productId: product.id, quantity: 20, unitPrice: 95 }]
                );
                
                results.innerHTML += logResult('建立進貨單', !!purchaseOrder);
                results.innerHTML += logResult('進貨單數量增加', inventorySystem.purchaseOrders.length === initialOrderCount + 1);
                
                if (purchaseOrder) {
                    results.innerHTML += logResult('進貨單狀態', purchaseOrder.status === 'pending');
                    results.innerHTML += logResult('進貨單總額', purchaseOrder.totalAmount === 1900); // 20 * 95
                    
                    // 測試收貨
                    inventorySystem.receivePurchaseOrder(purchaseOrder.id);
                    const updatedProduct = inventorySystem.getProductById(product.id);
                    const updatedOrder = inventorySystem.purchaseOrders.find(po => po.id === purchaseOrder.id);
                    
                    results.innerHTML += logResult('收貨狀態更新', updatedOrder.status === 'received');
                    results.innerHTML += logResult('庫存更新', updatedProduct.currentStock === initialStock + 20);
                }
                
                results.innerHTML += logInfo(`目前進貨單總數: ${inventorySystem.purchaseOrders.length}`);
                
            } catch (error) {
                results.innerHTML += logResult('進貨管理測試異常', false, error.message);
            }
        }
        
        function testSalesManagement() {
            const results = document.getElementById('sales-results');
            results.innerHTML = '<h3>執行銷貨管理測試...</h3>';
            
            try {
                if (!inventorySystem) {
                    inventorySystem = new InventorySystem();
                    // 確保有商品和客戶
                    inventorySystem.addProduct('TEST001', '測試商品', '', '個', 100, 150, 10, 50);
                    inventorySystem.addCustomer('測試客戶', '0912345678', '', '');
                }
                
                const customer = inventorySystem.customers[0];
                const product = inventorySystem.products[0];
                
                if (!product) {
                    results.innerHTML += logResult('銷貨測試準備', false, '缺少必要的商品資料');
                    return;
                }
                
                const initialOrderCount = inventorySystem.salesOrders.length;
                const initialStock = product.currentStock;
                
                // 測試建立銷貨單
                const salesOrder = inventorySystem.createSalesOrder(
                    customer ? customer.id : null,
                    new Date().toISOString().split('T')[0],
                    [{ productId: product.id, quantity: 5, unitPrice: 150 }]
                );
                
                results.innerHTML += logResult('建立銷貨單', !!salesOrder);
                results.innerHTML += logResult('銷貨單數量增加', inventorySystem.salesOrders.length === initialOrderCount + 1);
                
                if (salesOrder) {
                    results.innerHTML += logResult('銷貨單狀態', salesOrder.status === 'completed');
                    results.innerHTML += logResult('銷貨單總額', salesOrder.totalAmount === 750); // 5 * 150
                    
                    // 檢查庫存是否正確扣減
                    const updatedProduct = inventorySystem.getProductById(product.id);
                    results.innerHTML += logResult('庫存扣減', updatedProduct.currentStock === initialStock - 5);
                }
                
                results.innerHTML += logInfo(`目前銷貨單總數: ${inventorySystem.salesOrders.length}`);
                
            } catch (error) {
                results.innerHTML += logResult('銷貨管理測試異常', false, error.message);
            }
        }
        
        function testInventoryManagement() {
            const results = document.getElementById('inventory-results');
            results.innerHTML = '<h3>執行庫存管理測試...</h3>';
            
            try {
                if (!inventorySystem) {
                    inventorySystem = new InventorySystem();
                    inventorySystem.addProduct('TEST001', '測試商品', '', '個', 100, 150, 20, 5);
                }
                
                const product = inventorySystem.products[0];
                if (!product) {
                    results.innerHTML += logResult('庫存測試準備', false, '缺少必要的商品資料');
                    return;
                }
                
                const initialStock = product.currentStock;
                
                // 測試庫存調整 - 增加
                inventorySystem.adjustInventory(product.id, 'increase', 10, '測試增加庫存');
                let updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('庫存增加', updatedProduct.currentStock === initialStock + 10);
                
                // 測試庫存調整 - 減少
                const beforeDecrease = updatedProduct.currentStock;
                inventorySystem.adjustInventory(product.id, 'decrease', 5, '測試減少庫存');
                updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('庫存減少', updatedProduct.currentStock === beforeDecrease - 5);
                
                // 測試庫存調整 - 設定
                inventorySystem.adjustInventory(product.id, 'set', 30, '測試設定庫存');
                updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('庫存設定', updatedProduct.currentStock === 30);
                
                // 測試低庫存檢查
                inventorySystem.adjustInventory(product.id, 'set', 5, '設定為低庫存');
                updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('低庫存檢查', updatedProduct.isLowStock() === true);
                
                // 測試取得低庫存商品
                const lowStockProducts = inventorySystem.getLowStockProducts();
                results.innerHTML += logResult('取得低庫存商品', lowStockProducts.length > 0);
                
                results.innerHTML += logInfo(`調整記錄數: ${inventorySystem.inventoryAdjustments.length}`);
                
            } catch (error) {
                results.innerHTML += logResult('庫存管理測試異常', false, error.message);
            }
        }
        
        function testUtilities() {
            const results = document.getElementById('utility-results');
            results.innerHTML = '<h3>執行工具函數測試...</h3>';
            
            try {
                // 測試日期格式化
                const dateStr = '2024-12-25';
                const formattedDate = Utils.formatDate(dateStr);
                results.innerHTML += logResult('日期格式化', !!formattedDate);
                results.innerHTML += logInfo(`格式化日期: ${formattedDate}`);
                
                // 測試貨幣格式化
                const amount = 12345;
                const formattedCurrency = Utils.formatCurrency(amount);
                results.innerHTML += logResult('貨幣格式化', !!formattedCurrency);
                results.innerHTML += logInfo(`格式化貨幣: ${formattedCurrency}`);
                
                // 測試數字格式化
                const number = 1234567;
                const formattedNumber = Utils.formatNumber(number);
                results.innerHTML += logResult('數字格式化', !!formattedNumber);
                results.innerHTML += logInfo(`格式化數字: ${formattedNumber}`);
                
                // 測試ID生成
                const id = Utils.generateId();
                results.innerHTML += logResult('ID生成', !!id && id.length > 0);
                results.innerHTML += logInfo(`生成的ID: ${id}`);
                
                // 測試狀態文字
                const statusText = Utils.getStatusText('pending');
                results.innerHTML += logResult('狀態文字', statusText === '待處理');
                
                // 測試email驗證
                const validEmail = Utils.validateEmail('test@example.com');
                const invalidEmail = Utils.validateEmail('invalid-email');
                results.innerHTML += logResult('Email驗證(有效)', validEmail === true);
                results.innerHTML += logResult('Email驗證(無效)', invalidEmail === false);
                
                // 測試電話驗證
                const validPhone = Utils.validatePhone('02-12345678');
                const invalidPhone = Utils.validatePhone('123');
                results.innerHTML += logResult('電話驗證(有效)', validPhone === true);
                results.innerHTML += logResult('電話驗證(無效)', invalidPhone === false);
                
            } catch (error) {
                results.innerHTML += logResult('工具函數測試異常', false, error.message);
            }
        }
        
        function testCompleteWorkflow() {
            const results = document.getElementById('workflow-results');
            results.innerHTML = '<h3>執行完整流程測試...</h3>';
            
            try {
                // 重新初始化系統
                inventorySystem = new InventorySystem();
                
                // 1. 新增供應商
                const supplier = inventorySystem.addSupplier(
                    '流程測試供應商', '李先生', '02-87654321', 'supplier@test.com', '台北市', '87654321'
                );
                results.innerHTML += logResult('步驟1: 新增供應商', !!supplier);
                
                // 2. 新增客戶
                const customer = inventorySystem.addCustomer(
                    '流程測試客戶', '0987654321', 'customer@test.com', '新北市'
                );
                results.innerHTML += logResult('步驟2: 新增客戶', !!customer);
                
                // 3. 新增商品
                const product = inventorySystem.addProduct(
                    'FLOW001', '流程測試商品', '測試規格', '個', 80, 120, 15, 0
                );
                results.innerHTML += logResult('步驟3: 新增商品', !!product);
                
                // 4. 建立進貨單
                const purchaseOrder = inventorySystem.createPurchaseOrder(
                    supplier.id,
                    new Date().toISOString().split('T')[0],
                    [{ productId: product.id, quantity: 100, unitPrice: 75 }]
                );
                results.innerHTML += logResult('步驟4: 建立進貨單', !!purchaseOrder);
                
                // 5. 收貨(更新庫存)
                inventorySystem.receivePurchaseOrder(purchaseOrder.id);
                let updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('步驟5: 收貨更新庫存', updatedProduct.currentStock === 100);
                
                // 6. 建立銷貨單
                const salesOrder = inventorySystem.createSalesOrder(
                    customer.id,
                    new Date().toISOString().split('T')[0],
                    [{ productId: product.id, quantity: 30, unitPrice: 120 }]
                );
                results.innerHTML += logResult('步驟6: 建立銷貨單', !!salesOrder);
                
                // 7. 檢查庫存扣減
                updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('步驟7: 銷貨庫存扣減', updatedProduct.currentStock === 70);
                
                // 8. 庫存調整
                inventorySystem.adjustInventory(product.id, 'decrease', 60, '流程測試調整');
                updatedProduct = inventorySystem.getProductById(product.id);
                results.innerHTML += logResult('步驟8: 庫存調整', updatedProduct.currentStock === 10);
                
                // 9. 檢查低庫存警示
                const isLowStock = updatedProduct.isLowStock();
                results.innerHTML += logResult('步驟9: 低庫存警示', isLowStock === true);
                
                // 10. 檢查活動記錄
                const activityCount = inventorySystem.activities.length;
                results.innerHTML += logResult('步驟10: 活動記錄', activityCount > 0);
                
                results.innerHTML += logInfo(`完整流程測試完成 - 活動記錄數: ${activityCount}`);
                results.innerHTML += logInfo(`最終庫存: ${updatedProduct.currentStock} 個`);
                results.innerHTML += logInfo(`庫存價值: ${Utils.formatCurrency(updatedProduct.getStockValue())}`);
                
            } catch (error) {
                results.innerHTML += logResult('完整流程測試異常', false, error.message);
            }
        }
        
        function runAllTests() {
            clearResults();
            testSystemInit();
            setTimeout(() => testProductManagement(), 100);
            setTimeout(() => testCustomerManagement(), 200);
            setTimeout(() => testSupplierManagement(), 300);
            setTimeout(() => testPurchaseManagement(), 400);
            setTimeout(() => testSalesManagement(), 500);
            setTimeout(() => testInventoryManagement(), 600);
            setTimeout(() => testUtilities(), 700);
            setTimeout(() => testCompleteWorkflow(), 800);
            setTimeout(() => showSummary(), 1000);
        }
        
        function clearResults() {
            testResults = [];
            const resultDivs = ['init-results', 'product-results', 'customer-results', 
                               'supplier-results', 'purchase-results', 'sales-results', 
                               'inventory-results', 'utility-results', 'workflow-results'];
            
            resultDivs.forEach(divId => {
                const div = document.getElementById(divId);
                if (div) div.innerHTML = '';
            });
            
            document.getElementById('test-summary').style.display = 'none';
        }
        
        function showSummary() {
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.result === true).length;
            const failedTests = totalTests - passedTests;
            
            const summary = document.getElementById('test-summary');
            const content = document.getElementById('summary-content');
            
            content.innerHTML = `
                <p><strong>測試結果統計:</strong></p>
                <p>總測試數: ${totalTests}</p>
                <p style="color: #155724;">通過: ${passedTests}</p>
                <p style="color: #721c24;">失敗: ${failedTests}</p>
                <p><strong>成功率: ${totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0}%</strong></p>
                
                ${failedTests > 0 ? '<h4>失敗的測試:</h4>' : ''}
                ${testResults.filter(r => !r.result).map(r => 
                    `<p style="color: #721c24;">• ${r.test}${r.details ? ' - ' + r.details : ''}</p>`
                ).join('')}
            `;
            
            summary.style.display = 'block';
        }
    </script>
</body>
</html>